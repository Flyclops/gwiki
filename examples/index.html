<!DOCTYPE html>
<html>
<head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=2.0">
    <title>GWiki</title>

    <!-- Bring in the Gwiki Styles -->
    <link type="text/css" rel="stylesheet" href="/assets/base.css">
    <link type="text/css" rel="stylesheet" href="/assets/Gwiki.css">

    <!-- Make sure we've got a markdown parser -->
    <script type="text/javascript" src="/vendor/stackexchange/pagedown/Markdown.Converter.js"></script>

    <!-- Now include all of our program libraries -->
    <script type="text/javascript" src="/assets/Utils.js"></script>
    <script type="text/javascript" src="/assets/Gwiki.js"></script>
    <script type="text/javascript" src="/assets/GwikiUI.js"></script>

    <!-- Now initialize everything -->
    <script type="text/javascript">
        // This gets called when google's done loading it's api
        function init() {
            // Add a consumable type (example)
            // This would make Gwiki show google Drawings in your menus
            //Gwiki.consumableTypes.push('application/vnd.google-apps.drawing');

            // Create an instance of GwikiUI
            var ui = new GwikiUI({
                root : document.getElementsByClassName('gwiki-ui')[0],
                markdownParser: new Markdown.Converter()
            });

            // Initialize the google api
            gapi.client.init({
                discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
                clientId: 'YOUR_CLIENT_ID',
                scope: 'https://www.googleapis.com/auth/drive.readonly'
            }).then(function () {
                // Instantiate Gwiki
                window.gwiki = new Gwiki();

                // Make GwikiUI listen for Gwiki's events
                ui.subscribeListeners(window.gwiki);

                // Setup a callback function that makes the user sign into google an initializes the gwiki, if necessary
                var manageSignin = function (signedIn) {
                    if (signedIn) {
                        if (!window.gwiki.initialized) gwiki.init();
                    } else {
                        gapi.auth2.getAuthInstance().signIn();
                    }
                }

                // Set up a loop that makes sure the user stays signed in
                gapi.auth2.getAuthInstance().isSignedIn.listen(manageSignin);

                // Start it up by manually starting the signin loop
                manageSignin(gapi.auth2.getAuthInstance().isSignedIn.get());
            });
        }
    </script>
</head>
<body>

<!-- Give the Gwiki a root element and it'll do the rest -->
<div class="gwiki-ui">
</div>

<!-- Load google's api -->
<script async defer src="https://apis.google.com/js/api.js"
    onload="this.onload=function(){};gapi.load('client:auth2', init);"
    onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
</body>
</html>
